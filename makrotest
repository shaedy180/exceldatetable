Option Explicit

' ==== KONFIG ====
Private Const PIVOT_NAME As String = "ELV Erlöse"
' Falls Umsatz als T€ nur angezeigt werden soll (ohne /1000 im Quellfeld),
' kannst du unten im NumberFormat statt "#.##0" -> "#.##0"" T€""" setzen.

' ==== PIVOT HOLEN ====
Private Function GetPivot() As PivotTable
    Set GetPivot = ActiveSheet.PivotTables(PIVOT_NAME)
End Function

' ==== HILFE: DataField nach Caption oder SourceName suchen ====
Private Function FindDataField(pt As PivotTable, ByVal captionOrSource As String) As PivotField
    Dim df As PivotField
    ' 1) nach Caption suchen
    For Each df In pt.DataFields
        If StrComp(df.Caption, captionOrSource, vbTextCompare) = 0 Then
            Set FindDataField = df
            Exit Function
        End If
    Next df
    ' 2) nach SourceName suchen
    For Each df In pt.DataFields
        If StrComp(df.SourceName, captionOrSource, vbTextCompare) = 0 Then
            Set FindDataField = df
            Exit Function
        End If
    Next df
End Function

' ==== HILFE: sicherstellen, dass ein Feld in WERTE liegt, ggf. hinzufügen ====
Private Function EnsureDataField(pt As PivotTable, ByVal sourceFieldName As String, _
                                 ByVal desiredCaption As String, _
                                 ByVal agg As XlConsolidationFunction) As PivotField
    Dim df As PivotField, pf As PivotField

    Set df = FindDataField(pt, desiredCaption)
    If df Is Nothing Then Set df = FindDataField(pt, sourceFieldName)
    If Not df Is Nothing Then
        ' schon vorhanden -> Caption/Format/Aggregat setzen
        On Error Resume Next
        df.Function = agg
        df.Caption = desiredCaption
        On Error GoTo 0
        Set EnsureDataField = df
        Exit Function
    End If

    ' sonst aus den PivotFields hinzufügen
    On Error Resume Next
    Set pf = pt.PivotFields(sourceFieldName)
    On Error GoTo 0
    If Not pf Is Nothing Then
        pf.Orientation = xlDataField
        On Error Resume Next
        pf.Function = agg
        pf.Caption = desiredCaption               ' „Summe von …“ -> „Umsatz“ etc.
        On Error GoTo 0
        Set EnsureDataField = pf
    Else
        Set EnsureDataField = Nothing             ' Quellfeld existiert nicht
    End If
End Function

' ==== FORMAT je Feld ====
Private Sub ApplyNumberFormat(ByVal df As PivotField)
    If df Is Nothing Then Exit Sub
    Select Case LCase$(df.Caption)
        Case LCase$("Umsatz")
            df.NumberFormat = "#.##0"                 ' alternativ: "#.##0"" T€"""
        Case LCase$("Δ €")
            df.NumberFormat = "+#.##0;-#.##0;"        ' Null unsichtbar
        Case LCase$("Δ %")
            df.NumberFormat = "0,00%"
        Case LCase$("Menge"), LCase$("ΔMenge")
            df.NumberFormat = "#.##0"
        Case Else
            df.NumberFormat = "General"
    End Select
End Sub

' ==== REIHENFOLGE DER WERTEFELDER ====
Private Sub ReorderValues(pt As PivotTable, orderArr As Variant)
    Dim i As Long, df As PivotField
    For i = LBound(orderArr) To UBound(orderArr)
        Set df = FindDataField(pt, CStr(orderArr(i)))
        If Not df Is Nothing Then df.Position = i + 1
    Next i
End Sub

' ==== EINZEL-TOGGLES ====
Public Sub Toggle_Umsatz()
    Dim pt As PivotTable: Set pt = GetPivot()
    Dim df As PivotField
    pt.ManualUpdate = True
    Set df = FindDataField(pt, "Umsatz")
    If Not df Is Nothing Then
        df.Orientation = xlHidden
    Else
        Set df = EnsureDataField(pt, "Umsatz", "Umsatz", xlSum)
        ApplyNumberFormat df
    End If
    pt.ManualUpdate = False
    pt.TableRange1.Columns.AutoFit
End Sub

Public Sub Toggle_Menge()
    Dim pt As PivotTable: Set pt = GetPivot()
    Dim df As PivotField
    pt.ManualUpdate = True
    Set df = FindDataField(pt, "Menge")
    If Not df Is Nothing Then
        df.Orientation = xlHidden
    Else
        Set df = EnsureDataField(pt, "Menge", "Menge", xlSum)
        ApplyNumberFormat df
    End If
    pt.ManualUpdate = False
    pt.TableRange1.Columns.AutoFit
End Sub

Public Sub Toggle_DeltaEuro()
    Dim pt As PivotTable: Set pt = GetPivot()
    Dim df As PivotField
    pt.ManualUpdate = True
    Set df = FindDataField(pt, "Δ €")
    If Not df Is Nothing Then
        df.Orientation = xlHidden
    Else
        Set df = EnsureDataField(pt, "Δ €", "Δ €", xlSum)
        ApplyNumberFormat df
    End If
    pt.ManualUpdate = False
    pt.TableRange1.Columns.AutoFit
End Sub

Public Sub Toggle_DeltaPct()
    Dim pt As PivotTable: Set pt = GetPivot()
    Dim df As PivotField
    pt.ManualUpdate = True
    Set df = FindDataField(pt, "Δ %")
    If Not df Is Nothing Then
        df.Orientation = xlHidden
    Else
        ' % i. d. R. als Mittelwert sinnvoller
        Set df = EnsureDataField(pt, "Δ %", "Δ %", xlAverage)
        ApplyNumberFormat df
    End If
    pt.ManualUpdate = False
    pt.TableRange1.Columns.AutoFit
End Sub

Public Sub Toggle_DeltaMenge()
    Dim pt As PivotTable: Set pt = GetPivot()
    Dim df As PivotField
    pt.ManualUpdate = True
    Set df = FindDataField(pt, "ΔMenge")
    If Not df Is Nothing Then
        df.Orientation = xlHidden
    Else
        Set df = EnsureDataField(pt, "ΔMenge", "ΔMenge", xlSum)
        ApplyNumberFormat df
    End If
    pt.ManualUpdate = False
    pt.TableRange1.Columns.AutoFit
End Sub

' ==== PRESETS ====
Public Sub Show_Only_Umsatz()
    Dim pt As PivotTable: Set pt = GetPivot()
    Dim df As PivotField
    pt.ManualUpdate = True
    For Each df In pt.DataFields: df.Orientation = xlHidden: Next
    Set df = EnsureDataField(pt, "Umsatz", "Umsatz", xlSum)
    ApplyNumberFormat df
    ReorderValues pt, Array("Umsatz")
    pt.ManualUpdate = False
    pt.TableRange1.Columns.AutoFit
End Sub

Public Sub Show_Umsatz_und_DeltaEuro()
    Dim pt As PivotTable: Set pt = GetPivot()
    Dim df As PivotField
    pt.ManualUpdate = True
    For Each df In pt.DataFields: df.Orientation = xlHidden: Next
    ApplyNumberFormat EnsureDataField(pt, "Umsatz", "Umsatz", xlSum)
    ApplyNumberFormat EnsureDataField(pt, "Δ €",  "Δ €",  xlSum)
    ReorderValues pt, Array("Umsatz", "Δ €")
    pt.ManualUpdate = False
    pt.TableRange1.Columns.AutoFit
End Sub

Public Sub Show_All()
    Dim pt As PivotTable: Set pt = GetPivot()
    Dim df As PivotField
    pt.ManualUpdate = True
    For Each df In pt.DataFields: df.Orientation = xlHidden: Next
    ApplyNumberFormat EnsureDataField(pt, "Umsatz",  "Umsatz",  xlSum)
    ApplyNumberFormat EnsureDataField(pt, "Δ €",     "Δ €",     xlSum)
    ApplyNumberFormat EnsureDataField(pt, "Δ %",     "Δ %",     xlAverage)
    ApplyNumberFormat EnsureDataField(pt, "Menge",   "Menge",   xlSum)
    ApplyNumberFormat EnsureDataField(pt, "ΔMenge",  "ΔMenge",  xlSum)
    ReorderValues pt, Array("Umsatz", "Δ €", "Δ %", "Menge", "ΔMenge")
    pt.ManualUpdate = False
    pt.TableRange1.Columns.AutoFit
End Sub

Public Sub Hide_All()
    Dim pt As PivotTable: Set pt = GetPivot()
    Dim df As PivotField
    pt.ManualUpdate = True
    For Each df In pt.DataFields: df.Orientation = xlHidden: Next
    pt.ManualUpdate = False
End Sub
